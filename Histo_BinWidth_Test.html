<html>

<head>
    <!-- Custom Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Caveat">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Bitter">

    <!-- Custom CSS styles -->
    <link href="style.css" rel="stylesheet" type="text/css">

  <!-- Load d3 -->
  <script src="https://d3js.org/d3.v5.min.js"></script>

  <!-- Load d3-annotation -->
  <script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>

</head>


<body>

</body>



<script>

w = 400
h = 250

let lineMargin = {top: 45, right: 0, bottom: 30, left: 0};
let lineWidth = w - lineMargin.left - lineMargin.right,
    lineHeight = h - lineMargin.top - lineMargin.bottom;


svg = d3.select("body")
  .append("svg")
  .attr("width",100)
  .attr("height",h)

data = d3.range(1000).map(()=>d3.randomNormal(20,3)())
dataMax = d3.max(data)

let yScaleCUSUM = d3.scaleLinear()
  .domain([0,dataMax*1.6])
  .range([h,0]);

numBins = 100
histoRange = (d3.max(data)*1.6)//-d3.min(data)
binWidth = histoRange/numBins

thresholds = [0]
prevThreshold = 0
for (i = 0; i < numBins-1; i++){
  thresholds.push(prevThreshold + binWidth)
  prevThreshold = prevThreshold + binWidth
}

histogram = d3.histogram()
  .value(d => d)
  .domain(yScaleCUSUM.domain())
  .thresholds(thresholds)


bins = histogram(data)

histoX = d3.scaleLinear()
  .domain([0, d3.max(bins,function(d){return d.length;})])
  .range([0,85])

svg.append("g").attr("id","histoBars")
  .selectAll("rect")
  .data(bins)
  .enter()
  .append("rect")
    .attr("x",0)
    .attr("y",0)
    .attr("transform", function(d){return "translate(0, "+yScaleCUSUM(d.x1)+" )" })
    .attr("height",function(d){return yScaleCUSUM(d.x0) - yScaleCUSUM(d.x1); })
    .attr("width", function(d){return histoX(d.length);})
    .style("fill", function(d){return (d.x0 + d.x1)/2  > dataMax ? "#ccffff" : "black"})
    .attr("opacity",function(d){return (d.x0 + d.x1)/2  > dataMax ? 0.4 : 0.2})


</script>

</html>
